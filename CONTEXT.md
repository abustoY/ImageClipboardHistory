# プロジェクトコンテキスト: ImageClipboardHistory

このドキュメントは、このプロジェクトの開発を継続するためにAIアシスタントとの新しいセッションを開始する際のコンテキストプロンプトとして使用してください。

## 1. プロジェクト概要
このプロジェクトは、**macOS専用のメニューバー常駐型画像クリップボード履歴アプリ**です。テキスト履歴は排除し、画像データおよび画像ファイルのコピー履歴のみを管理・再利用することに特化しています。

## 2. 技術スタック
- **プラットフォーム**: macOS (13.0+)
- **言語/フレームワーク**: Swift, SwiftUI
- **UI コンポーネント**: AppKit (NSStatusItem, NSPopover) 経由で SwiftUI View を表示
- **ショートカット管理**: Carbon API (RegisterEventHotKey)
- **クリップボード監視**: `NSPasteboard` 監視（タイマーによるポーリング）

## 3. UI/UX仕様 (重要)
デザイン哲学は **「ミニマル、高速、そしてキーボード完結」** です。

### A. 表示形式
- **常駐場所**: メニューバー。アイコンは `photo.on.rectangle` (SF Symbols)。
- **ウィンドウ形状**: `NSPopover` によるポップアップ。幅 320px、高さ 600px 固定。
- **リスト表示**: `LazyVGrid` による2列の画像グリッド。
- **画像サイズ**: アスペクト比を維持しつつ `140px` の高さに統一。

### B. レイアウト構造 (バーのコンパクト化)
- **ヘッダー**: 左側に「ImageClipboardHistory」タイトル、右端に「ゴミ箱」ボタンを配置。縦幅は最小限に抑える。
- **フッター**: 区切り線の下に「終了」ボタンのみを配置。高さは上部ヘッダーと視覚的に揃える。
- **メインエリア**: ウィンドウのほぼ全域が画像一覧に使用される。

### C. インタラクション & ホバー効果
- **画像アイテム**: ホバー時に `accentColor` (青) の枠線と、うっすらとした背景ハイライトを表示。
- **アクションボタン**: 
    - ゴミ箱: ホバー時に赤色に変化。
    - 終了: ホバー時に背景が強調。
- **ホバー判定**: 画像およびラベルの境界内のみが反応し、デッドスペースでの誤反応を防ぐ。

## 4. 機能・挙動ルール
### A. ショートカット (Maccy風)
- **グローバル呼び出し**: `Shift + Command + X`。どこにいてもメニューを即座に表示。
- **瞬時の反応**: `NSPopover` のアニメーション (`animates`) は必ず **`false`** に設定し、体感速度を最優先する。
- **Enterキー確定**: メニュー表示中に `Enter (Return)` を押すと、最上部（最新）の画像をコピーしてウィンドウを閉じる。

### B. クリップボード管理
- **画像検知**: `NSImage` として読めるデータ、または画像ファイル（URL）のコピーのみを拾う。履歴は最大 **100件**。
- **重複挙動**: 履歴にある画像を再度コピーした場合、その画像が履歴の「先頭」に移動する（Maccyと同じ動作）。
- **自動クローズ**: 画像選択（クリック/Enter）後は、即座にウィンドウを閉じる。

### C. アプリケーション設定
- **アクセサリモード**: Dock にアイコンを表示せず、メニューバーのみで動作。
- **プロセス管理**: 複数起動を防ぎ、メニューバーから「終了」を選択しない限り常駐。

## 5. ファイル構造
- `ImageClipboardHistoryApp.swift`: `AppDelegate` による `NSStatusItem` / `NSPopover` 管理、グローバルショートカット、バックグラウンド設定。
- `ContentView.swift`: メインUI。画像グリッド、ホバー効果、Enterキー監視。
- `ClipboardImageHistory.swift`: クリップボード監視コアロジック、データ管理。

## 6. 今後の開発への指示
- **バーのコンパクトさの維持**: ヘッダーやフッターに余白やタイトルを追加し、縦幅を広げる変更は避けてください。
- **画像特化の維持**: テキストや他のデータ型をサポートする際は、画像専用としてのシンプルさを損なわないようにしてください。
- **キーボード操作の優先**: キーボードだけで主要な操作（呼び出し・選択・完了）ができるよう、アクセシビリティとショートカットに配慮してください。
### Git コミット／Push ルール

#### 禁止事項
- APIキー / トークン / パスワード / 秘密鍵 / .env
- 個人情報・実データ・認証ログ
- ビルド成果物 / キャッシュ / 大容量バイナリ
- .gitignore 対象

#### 画像は特に慎重に
以下の可能性がある画像はコミット禁止：
- プロフィール画像 / 顔写真 / 実在人物
- Googleアカウント画像などのサービス画像
- スクリーンショット（メール・ブラウザ・チャット等）
- QRコード / 招待URL / 認証画面

#### 画像をコミットして良い条件
- 本番リポジトリで正式に使用するアセット
- 個人情報や外部サービス画像を含まない
- 必要目的が明確

#### ユーザー確認は必須
あなたの判断で commit / push してはいけません。
必ず以下を提示し、承認を得てください：
1. コミット対象ファイル一覧
2. 変更要約
3. セキュリティリスク自己チェック結果
4. 画像がある場合 → 画像一覧と用途説明

ユーザーが「YES」と明示した場合のみ commit / push 実行。

#### 不明な場合
勝手に進めない。必ず質問。

## 7. App Icon Specifications (Critical)
macOS アプリアイコン作成時の厳格なルール：

1.  **角丸処理は自前で行う**:
    - **iOSとは異なる**: iOSはOSが自動で角丸マスクを適用するが、**macOSは画像の透明度をそのまま尊重する**。
    - **禁止事項**: 「正方形の画像を渡せばOSが丸くしてくれる」という認識は誤り。正方形を渡すと正方形のまま表示される。
    - **正解**: アプリ開発者が、画像データそのものに「角丸（Squircle）」と「背景透明」を焼き込んでおく必要がある。

    > **References**:
    > - [Apple HIG: App Icons](https://developer.apple.com/design/human-interface-guidelines/app-icons) ("Keep the icon shape simple" - macOS allows various shapes implies direct transparency handling)
    > - [StackOverflow discussion](https://stackoverflow.com/questions/65412431/macos-big-sur-app-icon-shape) ("On macOS, you provide the masked image.")

2.  **生成手順**:
    - 素材は 1024x1024 の正方形で作る。
    - 必ず **Squircle (Superellipse)** 形状のマスクを適用し、四隅を**完全に透明 (Alpha=0)** にする。
    - 白色の背景などが残っていないか、プログラム（Python/Pillow等）で四隅のピクセル値を検査すること。
